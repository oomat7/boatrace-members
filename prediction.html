<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>æœ¬æ—¥ã®AIãƒœãƒ¼ãƒˆäºˆæƒ³ - ä¼šå“¡å°‚ç”¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <!-- Supabase v2 + è¨­å®š -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="config.js" defer></script>

    <!-- âœ… ãƒãƒ©è¦‹é˜²æ­¢ã‚¬ãƒ¼ãƒ‰ï¼ˆæœ€é‡è¦ï¼‰ -->
    <style>
      html.guard body {
        visibility: hidden;
      }
      #guard-loading {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        color: rgba(226, 232, 240, 0.85);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP",
          sans-serif;
        letter-spacing: 0.08em;
        font-size: 14px;
      }
    </style>

    <script>
      document.documentElement.classList.add("guard");

      const loading = document.createElement("div");
      loading.id = "guard-loading";
      loading.textContent = "LOADING...";
      document.addEventListener("DOMContentLoaded", () => {
        document.body.appendChild(loading);
      });

      window.__unlockGuard = () => {
        document.documentElement.classList.remove("guard");
        const el = document.getElementById("guard-loading");
        if (el) el.remove();
      };
    </script>
  </head>

  <body>
    <!-- ä¸Šã®ãƒãƒ¼ -->
    <header class="bar">
      <div class="bar-left">
        <div class="brand-main"><span>AI</span> BOATRACE MEMBERS</div>
        <div class="brand-sub">BOATRACE PREMIUM AI PREDICTION</div>
      </div>
      <div class="bar-right">æœ¬æ—¥ã®äºˆæƒ³ï¼ˆä¼šå“¡å°‚ç”¨ï¼‰</div>
    </header>

    <main class="page">
      <section class="card">
        <h1 class="title-center">æœ¬æ—¥ã®AIãƒœãƒ¼ãƒˆäºˆæƒ³</h1>
        <p class="muted" id="status-text">ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªä¸­ã§ã™...</p>

        <!-- âœ… æœ‰æ–™OKã®ã¨ãã ã‘è¡¨ç¤º -->
        <div id="prediction-content" style="display:none; margin-top: 14px">
          <div class="input-wrap">
            <label for="date-select">æ—¥ä»˜</label>
            <select id="date-select"></select>

            <label for="stadium-select" style="margin-top: 10px">ç«¶è‰‡å ´</label>
            <select id="stadium-select"></select>
          </div>

          <div id="predictions-area" class="input-wrap" style="margin-top: 14px">
            <p class="muted">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>

          <div class="btn-col" style="margin-top: 16px">
            <button type="button" class="btn-full" onclick="location.href='members.html'">
              ä¼šå“¡ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
            </button>
            <button type="button" class="btn-full" id="logout-button">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </div>

        <!-- âŒ ãƒ–ãƒ­ãƒƒã‚¯ -->
        <div id="blocked-content" class="input-wrap" style="display:none; margin-top: 16px">
          <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ <strong>æœ‰æ–™ä¼šå“¡å°‚ç”¨</strong> ã§ã™ã€‚</p>
          <p class="muted" id="blocked-reason" style="margin-top: 6px"></p>
        </div>
      </section>

      <div class="footer">Â© 2025 AI BOATRACE LAB</div>
    </main>

    <script>
      const REQUIRE_PAID_MEMBER = true;

      function formatJST(iso) {
        const d = new Date(iso);
        if (isNaN(d)) return "ä¸æ­£ãªæ—¥ä»˜";
        return d.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
      }

      function buildAccessInfo(accessUntilRaw) {
        if (!accessUntilRaw) {
          return { active: !REQUIRE_PAID_MEMBER, accessText: "æœªè¨­å®š", statusText: "ç„¡æ–™ä¼šå“¡" };
        }
        const d = new Date(accessUntilRaw);
        const now = new Date();
        return d >= now
          ? { active: true, accessText: formatJST(accessUntilRaw), statusText: "æœ‰åŠ¹ï¼ˆæœ‰æ–™ä¼šå“¡ï¼‰" }
          : { active: false, accessText: formatJST(accessUntilRaw), statusText: "æœŸé™åˆ‡ã‚Œ" };
      }

      const unique = (arr) => [...new Set(arr)];
      const sortRaceNo = (a, b) => (a.race_no || 0) - (b.race_no || 0);
      const escapeHTML = (s) =>
        String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");

      // âœ… premium ã®ã¨ãã ã‘ row.ana ã‚’è¡¨ç¤ºï¼ˆã‚ã‚Œã°ï¼‰
      function renderPredictions(list, userPlan) {
        const area = document.getElementById("predictions-area");
        if (!list || list.length === 0) {
          area.innerHTML = `<p class="muted">è©²å½“ã™ã‚‹äºˆæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
          return;
        }

        list.sort(sortRaceNo);

        const isPremium = userPlan === "premium";

        area.innerHTML = list
          .map((row) => {
            const anaText = row.ana ?? "";

            const anaBlock =
              isPremium && anaText
                ? `
                <div style="margin-top:12px; padding:10px; border:1px dashed rgba(250,204,21,.6); border-radius:10px">
                  <div style="font-weight:700; color:#facc15">ğŸ”¥ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šãƒ»ç©´äºˆæƒ³</div>
                  <div style="white-space:pre-wrap; margin-top:6px">${escapeHTML(anaText)}</div>
                </div>`
                : "";

            return `
              <div style="padding:14px; border:1px solid rgba(148,163,184,.35); border-radius:14px; margin-top:12px">
                <strong>${escapeHTML(row.race_no)}R</strong>
                <div style="margin-top:8px"><b>è²·ã„ç›®</b><br>${escapeHTML(row.picks)}</div>
                <div style="margin-top:8px"><b>ã‚³ãƒ¡ãƒ³ãƒˆ</b><br>${escapeHTML(row.notes)}</div>
                ${anaBlock}
              </div>`;
          })
          .join("");
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const statusText = document.getElementById("status-text");
        const predictionContent = document.getElementById("prediction-content");
        const blockedContent = document.getElementById("blocked-content");
        const blockedReason = document.getElementById("blocked-reason");
        const logoutBtn = document.getElementById("logout-button");

        if (!window.supabaseClient) {
          window.__unlockGuard();
          return;
        }

        const { data: { user } } = await window.supabaseClient.auth.getUser();
        if (!user) {
          window.__unlockGuard();
          location.href = "index.html";
          return;
        }

        const accessInfo = buildAccessInfo(user.user_metadata?.access_until);
        statusText.textContent = accessInfo.statusText;

        if (!accessInfo.active) {
          blockedContent.style.display = "block";
          blockedReason.textContent = "æœ‰æ–™ä¼šå“¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ / æœŸé™åˆ‡ã‚Œã§ã™ã€‚ä¼šå“¡ãƒšãƒ¼ã‚¸ã§æ±ºæ¸ˆã—ã¦ãã ã•ã„ã€‚";
          window.__unlockGuard();
          setTimeout(() => (location.href = "members.html"), 100);
          return;
        }

        predictionContent.style.display = "block";
        window.__unlockGuard();

        const res = await fetch(`data/predictions.json?v=${Date.now()}`, { cache: "no-store" });
        const data = await res.json();

        const dates = unique(data.map((r) => r.race_date).filter(Boolean)).sort().reverse();
        const dateSelect = document.getElementById("date-select");
        const stadiumSelect = document.getElementById("stadium-select");

        dateSelect.innerHTML = dates.map((d) => `<option>${escapeHTML(d)}</option>`).join("");
        dateSelect.value = dates[0] || "";

        const stadiumsByDate = (d) =>
          unique(
            data
              .filter((r) => r.race_date === d)
              .map((r) => r.stadium)
              .filter(Boolean)
          );

        const fillStadiums = (d) => {
          const list = stadiumsByDate(d);
          stadiumSelect.innerHTML = list.map((s) => `<option>${escapeHTML(s)}</option>`).join("");
          stadiumSelect.value = list[0] || "";
        };

        const refresh = () => {
          const filtered = data.filter(
            (r) => r.race_date === dateSelect.value && r.stadium === stadiumSelect.value
          );
          renderPredictions(filtered, user.user_metadata?.plan || "lite");
        };

        fillStadiums(dateSelect.value);
        refresh();

        dateSelect.addEventListener("change", () => {
          fillStadiums(dateSelect.value);
          refresh();
        });
        stadiumSelect.addEventListener("change", refresh);

        logoutBtn.addEventListener("click", async () => {
          await window.supabaseClient.auth.signOut();
          location.href = "index.html";
        });
      });
    </script>
  </body>
</html>
