<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>会員ページ - ボート予想 会員サイト</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="config.js" defer></script>
  </head>

  <body>
    <!-- 上のバー -->
    <header class="bar">
      <div class="bar-left">
        <div class="brand-main">
          <span>AI</span> BOATRACE MEMBERS
        </div>
        <div class="brand-sub">BOATRACE PREMIUM AI PREDICTION</div>
      </div>
      <div class="bar-right">会員ページ</div>
    </header>

    <main class="page">
      <section class="card">
        <h1 class="title-center">会員ページ</h1>
        <p class="muted" id="welcome-text">ログイン情報を取得中です...</p>

        <div class="input-wrap" style="margin-top: 18px">
          <p>
            <strong>登録メールアドレス：</strong>
            <span id="user-email">-</span>
          </p>
          <p>
            <strong>選択プラン：</strong>
            <span id="user-plan">-</span>
          </p>
          <p>
            <strong>支払い方法：</strong>
            <span id="user-payment">-</span>
          </p>
        </div>

        <div class="input-wrap" style="margin-top: 18px">
          <h3 style="font-size: 15px; margin-bottom: 8px">
            Stripeで決済する
          </h3>
          <p class="muted">
            下のボタンを押すと、選択中プランのStripe決済ページへ移動します。<br />
            決済完了後は、管理側で入金確認を行い、本会員権限を付与します。
          </p>

          <div class="btn-col" style="margin-top: 14px">
            <button type="button" class="primary btn-full" id="pay-button">
              このプランで決済へ進む
            </button>

            <button
              type="button"
              class="btn-full"
              id="logout-button"
            >
              ログアウト
            </button>
          </div>

          <p id="members-msg" class="muted" style="margin-top: 10px"></p>
        </div>
      </section>

      <div class="footer">© 2025 AI BOATRACE LAB</div>
    </main>

    <script>
      let currentPlan = null;

      const PLAN_LABELS = {
        lite: "ライトプラン（例：月1,280円）",
        standard: "スタンダードプラン",
        premium: "プレミアムプラン",
      };

      document.addEventListener("DOMContentLoaded", async () => {
        const msgEl = document.getElementById("members-msg");
        const welcomeEl = document.getElementById("welcome-text");
        const emailEl = document.getElementById("user-email");
        const planEl = document.getElementById("user-plan");
        const paymentEl = document.getElementById("user-payment");
        const payBtn = document.getElementById("pay-button");
        const logoutBtn = document.getElementById("logout-button");

        msgEl.textContent = "";

        if (!window.supabaseClient) {
          welcomeEl.textContent =
            "Supabaseの設定（config.js）が見つかりません。";
          return;
        }

        // ユーザー情報を取得
        const {
          data: { user },
          error,
        } = await window.supabaseClient.auth.getUser();

        if (error || !user) {
          welcomeEl.textContent =
            "ログイン情報が見つかりません。ログインし直してください。";
          msgEl.textContent = "";
          setTimeout(() => {
            location.href = "index.html";
          }, 1500);
          return;
        }

        // メールアドレス
        emailEl.textContent = user.email || "-";

        // signup時に入れた user_metadata を読む
        const meta = user.user_metadata || {};
        currentPlan = meta.plan || "lite";
        const paymentMethod = meta.payment_method || "card";

        // 表示用に変換
        planEl.textContent = PLAN_LABELS[currentPlan] || currentPlan;
        paymentEl.textContent =
          paymentMethod === "card"
            ? "クレジットカード（Stripe）"
            : paymentMethod;

        welcomeEl.textContent = "ようこそ、" + (meta.name || "会員") + " さん";

        // 決済ボタン
        payBtn.addEventListener("click", () => {
          msgEl.classList.remove("err");
          msgEl.textContent = "";

          if (!currentPlan) {
            msgEl.textContent = "プラン情報が取得できていません。";
            msgEl.classList.add("err");
            return;
          }

          if (!window.planPaymentLinks) {
            msgEl.textContent =
              "Stripeの決済リンクが設定されていません（config.js）。";
            msgEl.classList.add("err");
            return;
          }

          const url = window.planPaymentLinks[currentPlan];
          if (!url) {
            msgEl.textContent =
              "このプラン用の決済リンクが見つかりません。管理者にお問い合わせください。";
            msgEl.classList.add("err");
            return;
          }

          // Stripeの決済ページへ移動
          window.location.href = url;
        });

        // ログアウト
        logoutBtn.addEventListener("click", async () => {
          await window.supabaseClient.auth.signOut();
          location.href = "index.html";
        });
      });
    </script>
  </body>
</html>
