<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>会員ページ - ボート予想 会員サイト</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="config.js" defer></script>
  </head>

  <body>
    <!-- 上のバー -->
    <header class="bar">
      <div class="bar-left">
        <div class="brand-main">
          <span>AI</span> BOATRACE MEMBERS
        </div>
        <div class="brand-sub">BOATRACE PREMIUM AI PREDICTION</div>
      </div>
      <div class="bar-right">会員ページ</div>
    </header>

    <main class="page">
      <section class="card">
        <h1 class="title-center">会員ページ</h1>
        <p class="muted" id="welcome-text">ログイン情報を取得中です...</p>

        <!-- ユーザー情報表示 -->
        <div class="input-wrap" style="margin-top: 18px">
          <p>
            <strong>登録メールアドレス：</strong>
            <span id="user-email">-</span>
          </p>
          <p>
            <strong>現在のプラン：</strong>
            <span id="user-plan-label">未設定</span>
          </p>
          <p>
            <strong>有効期限：</strong>
            <span id="user-access-until">未設定</span>
          </p>
          <p>
            <strong>会員ステータス：</strong>
            <span id="user-status">無料会員（有効期限なし）</span>
          </p>
        </div>

        <!-- プラン選択（カード式） -->
        <div class="input-wrap" style="margin-top: 18px">
          <h3 style="font-size: 15px; margin-bottom: 8px">プランを選択</h3>
          <p class="muted">
            登録後でも、ここからいつでもプランを変更できます。<br />
            決済は、選択したプランに応じてStripeの画面に移動します。
          </p>

          <div class="plan-cards" id="plan-cards">
            <div class="plan-card" data-plan="lite">
              <div class="plan-name">ライトプラン</div>
              <div class="plan-price">例）月額 1,280円</div>
              <ul class="plan-features">
                <li>予想閲覧の基本機能</li>
                <li>まずはお試しで使いたい方向け</li>
              </ul>
            </div>

            <div class="plan-card" data-plan="standard">
              <div class="plan-name">スタンダードプラン</div>
              <div class="plan-price">価格は後で設定</div>
              <ul class="plan-features">
                <li>ライトよりも情報量アップ</li>
                <li>通常利用におすすめ</li>
              </ul>
            </div>

            <div class="plan-card" data-plan="premium">
              <div class="plan-name">プレミアムプラン</div>
              <div class="plan-price">価格は後で設定</div>
              <ul class="plan-features">
                <li>すべての機能をフル解放</li>
                <li>本気で勝ちにいきたい方向け</li>
              </ul>
            </div>
          </div>

          <div class="btn-col" style="margin-top: 16px">
            <button type="button" class="btn-full" id="save-plan-button">
              このプランを保存する
            </button>
            <button type="button" class="primary btn-full" id="pay-button">
              このプランで決済へ進む
            </button>
          </div>

          <p id="members-msg" class="muted" style="margin-top: 10px"></p>
        </div>

        <!-- 予想ページ＆ログアウト -->
        <div class="input-wrap" style="margin-top: 18px">
          <div class="btn-col">
            <button type="button" class="primary btn-full" id="open-prediction">
              本日の予想ページを開く
            </button>
            <button type="button" class="btn-full" id="logout-button">
              ログアウト
            </button>
          </div>
        </div>
      </section>

      <div class="footer">© 2025 AI BOATRACE LAB</div>
    </main>

    <script>
      const PLAN_LABELS = {
        lite: "ライトプラン",
        standard: "スタンダードプラン",
        premium: "プレミアムプラン",
      };

      let currentPlan = null;
      let userMeta = {};

      // 有効期限を表示用テキストとステータスに変換
      function buildAccessInfo(accessUntilRaw) {
        if (!accessUntilRaw) {
          return {
            accessText: "未設定",
            statusText: "無料会員（有効期限なし）",
          };
        }

        const d = new Date(accessUntilRaw);
        if (isNaN(d.getTime())) {
          return {
            accessText: "不正な日付（管理者に確認してください）",
            statusText: "状態不明",
          };
        }

        // 表示用（日付＋時刻、日本時間）
        const accessText = d.toLocaleString("ja-JP", {
          timeZone: "Asia/Tokyo",
        });

        const now = new Date();
        if (d.getTime() >= now.getTime()) {
          return {
            accessText,
            statusText: "有効（有料会員）",
          };
        } else {
          return {
            accessText,
            statusText: "期限切れ（再決済が必要です）",
          };
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const msgEl = document.getElementById("members-msg");
        const welcomeEl = document.getElementById("welcome-text");
        const emailEl = document.getElementById("user-email");
        const planLabelEl = document.getElementById("user-plan-label");
        const accessEl = document.getElementById("user-access-until");
        const statusEl = document.getElementById("user-status");
        const planCards = document.querySelectorAll(".plan-card");
        const savePlanBtn = document.getElementById("save-plan-button");
        const payBtn = document.getElementById("pay-button");
        const logoutBtn = document.getElementById("logout-button");
        const openPredictionBtn = document.getElementById("open-prediction");

        msgEl.textContent = "";

        if (!window.supabaseClient) {
          welcomeEl.textContent =
            "Supabaseの設定（config.js）が見つかりません。";
          return;
        }

        // ログインユーザー情報取得
        const {
          data: { user },
          error,
        } = await window.supabaseClient.auth.getUser();

        if (error || !user) {
          welcomeEl.textContent =
            "ログイン情報が見つかりません。ログインし直してください。";
          setTimeout(() => {
            location.href = "index.html";
          }, 1500);
          return;
        }

        userMeta = user.user_metadata || {};
        emailEl.textContent = user.email || "-";

        // プラン
        currentPlan = userMeta.plan || "lite";
        planLabelEl.textContent =
          PLAN_LABELS[currentPlan] || "未設定（ライト扱い）";

        // 有効期限＋ステータス
        const accessInfo = buildAccessInfo(userMeta.access_until);
        accessEl.textContent = accessInfo.accessText;
        statusEl.textContent = accessInfo.statusText;

        welcomeEl.textContent = "ようこそ、" + (userMeta.name || "moguo") + " さん";

        // プランカードの見た目更新
        function updateSelectedCard(plan) {
          planCards.forEach((card) => {
            if (card.dataset.plan === plan) {
              card.classList.add("selected");
            } else {
              card.classList.remove("selected");
            }
          });
          planLabelEl.textContent = PLAN_LABELS[plan] || plan;
        }

        updateSelectedCard(currentPlan);

        // カードクリックでプラン変更
        planCards.forEach((card) => {
          card.addEventListener("click", () => {
            const plan = card.dataset.plan;
            currentPlan = plan;
            updateSelectedCard(plan);
          });
        });

        // プラン保存ボタン（将来の拡張用に残す）
        savePlanBtn.addEventListener("click", async () => {
          msgEl.classList.remove("err");
          msgEl.textContent = "";

          if (!currentPlan) {
            msgEl.textContent = "プランが選択されていません。";
            msgEl.classList.add("err");
            return;
          }

          // access_until など既存のメタ情報は維持したまま plan だけ更新
          const newMeta = Object.assign({}, userMeta, { plan: currentPlan });

          msgEl.textContent = "プランを保存しています...";

          const { data, error } =
            await window.supabaseClient.auth.updateUser({
              data: newMeta,
            });

          if (error) {
            msgEl.textContent = "保存エラー： " + error.message;
            msgEl.classList.add("err");
            return;
          }

          userMeta = newMeta;
          msgEl.textContent = "プランを保存しました。";
        });

        // 決済ボタン
        payBtn.addEventListener("click", () => {
          msgEl.classList.remove("err");
          msgEl.textContent = "";

          if (!currentPlan) {
            msgEl.textContent = "プランが選択されていません。";
            msgEl.classList.add("err");
            return;
          }

          if (!window.planPaymentLinks) {
            msgEl.textContent =
              "Stripeの決済リンクが設定されていません（config.js）。";
            msgEl.classList.add("err");
            return;
          }

          const url = window.planPaymentLinks[currentPlan];
          if (!url) {
            msgEl.textContent =
              "このプラン用の決済リンクが見つかりません。管理者にお問い合わせください。";
            msgEl.classList.add("err");
            return;
          }

          // Stripe 決済画面へ遷移
          window.location.href = url;
        });

        // 予想ページへ
        openPredictionBtn.addEventListener("click", () => {
          location.href = "prediction.html";
        });

        // ログアウト
        logoutBtn.addEventListener("click", async () => {
          await window.supabaseClient.auth.signOut();
          location.href = "index.html";
        });
      });
    </script>
  </body>
</html>
